<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="我对DNN知识系统整理的一次尝试">
        
        <link rel="canonical" href="https://learnai-cn.github.io/05%20Detection/06%20YOLOv2/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>YOLOv2 - LearnAI-CN</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="../../css/style.css" rel="stylesheet">
        <link href="../../css/admonition_fix.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-80323542-1', 'auto');
          ga('send', 'pageview');
        </script>
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">LearnAI-CN</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">主页</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">目录 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../../intro/">简介</a>
</li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">入门</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../01%20Getting%20started/01%20Introduction/">深度学习介绍</a>
</li>

        
            
<li >
    <a href="../../01%20Getting%20started/02%20Perceptron/">感知机</a>
</li>

        
            
<li >
    <a href="../../01%20Getting%20started/03%20XOR/">异或操作</a>
</li>

        
            
<li >
    <a href="../../01%20Getting%20started/04%20S%20neural/">s型神经元</a>
</li>

        
            
<li >
    <a href="../../01%20Getting%20started/05%20loss%20functional/">损失函数</a>
</li>

        
            
<li >
    <a href="../../01%20Getting%20started/06%20Backpropagation/">反向传播算法</a>
</li>

        
            
<li >
    <a href="../../01%20Getting%20started/07%20Selflearning%20XOR/">自学习异或操作</a>
</li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">走向深度</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../02%20HardWayToDeep/01%201Channel%20minist/">minist实现</a>
</li>

        
            
<li >
    <a href="../../02%20HardWayToDeep/02%20Gradient%20vanishing/">梯度消失/爆炸</a>
</li>

        
            
<li >
    <a href="../../02%20HardWayToDeep/03%20generalization/">泛化性</a>
</li>

        
            
<li >
    <a href="../../02%20HardWayToDeep/04%20overfitting/">过拟合/欠拟合</a>
</li>

        
            
<li >
    <a href="../../02%20HardWayToDeep/05%20regulization/">正则化</a>
</li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">实现minist</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../02%20minist/01%20Convolution/">卷积层</a>
</li>

        
            
<li >
    <a href="../../02%20minist/02%20Pooling/">池化层</a>
</li>

        
            
<li >
    <a href="../../02%20minist/03%20Activation/">激活层</a>
</li>

        
            
<li >
    <a href="../../02%20minist/04%20Fully%20conection/">全连接层</a>
</li>

        
            
<li >
    <a href="../../02%20minist/05%20Optimization%20Algorithm/">优化函数</a>
</li>

        
            
<li >
    <a href="../../02%20minist/06%20Normalization/">归一化层</a>
</li>

        
            
<li >
    <a href="../../02%20minist/07%20LeNet/">再次实现minist</a>
</li>

        
            
<li >
    <a href="../../02%20minist/08%20WhyDCNNUseful/">为什么卷积有效</a>
</li>

        
            
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">深入介绍</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../02%20minist/09%20Deep%20introduce/01%20DNN%20feature/">DNN特性</a>
</li>

        
            
<li >
    <a href="../../02%20minist/09%20Deep%20introduce/02%20pooling%20BP/">池化层反向传播</a>
</li>

        
            
<li >
    <a href="../../02%20minist/09%20Deep%20introduce/03%20Receptive%20Field/">感受野</a>
</li>

        
    </ul>
  </li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">经典神经网络</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../03%20classicial%20model/01%20AlexNet/">AlexNet</a>
</li>

        
            
<li >
    <a href="../../03%20classicial%20model/02%20VGG/">VGG</a>
</li>

        
            
<li >
    <a href="../../03%20classicial%20model/03%20GoogleNet/">GoogLeNet</a>
</li>

        
            
<li >
    <a href="../../03%20classicial%20model/04%20ResNet/">ResNet</a>
</li>

        
            
<li >
    <a href="../../03%20classicial%20model/05%20DenseNet/">DenseNet</a>
</li>

        
            
<li >
    <a href="../../03%20classicial%20model/06%20SENet/">SENet</a>
</li>

        
            
<li >
    <a href="../../03%20classicial%20model/07%20MobileNet/">MoblieNet</a>
</li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">分割任务</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../04%20Segmentation/01%20Introduction/">介绍与基础</a>
</li>

        
            
<li >
    <a href="../../04%20Segmentation/02%20FCN/">FCN</a>
</li>

        
            
<li >
    <a href="../../04%20Segmentation/03%20UNet/">Unet</a>
</li>

        
            
<li >
    <a href="../../04%20Segmentation/04%20DeepLab%E7%B3%BB%E5%88%97/">DeepLab系列</a>
</li>

        
            
<li >
    <a href="../../04%20Segmentation/05%20DANet/">DANet</a>
</li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">检测</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../01%20Introduction/">介绍</a>
</li>

        
            
<li >
    <a href="../02%20RCNN/">RCNN</a>
</li>

        
            
<li >
    <a href="../03%20Fast%20RCNN/">Fast RCNN</a>
</li>

        
            
<li >
    <a href="../04%20Faster%20RCNN/">Faster RCNN</a>
</li>

        
            
<li >
    <a href="../05%20YOLOv1/">YOLOv1</a>
</li>

        
            
<li class="active">
    <a href="./">YOLOv2</a>
</li>

        
            
<li >
    <a href="../07%20YOLOv3/">YOLOv3</a>
</li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">Transformer</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../06%20Transformer/01%20Debugging/">Transformer</a>
</li>

        
            
<li >
    <a href="../../06%20Transformer/02%20Text%20Rendering/">ViT</a>
</li>

        
            
<li >
    <a href="../../06%20Transformer/03%20SwinTransformer/">SwinTransformer</a>
</li>

        
            
<li >
    <a href="../../06%20Transformer/04%20DETR/">DETR</a>
</li>

        
            
<li >
    <a href="../../06%20Transformer/05%20TransSeg/">TransFormer分割</a>
</li>

        
            
<li >
    <a href="../../06%20Transformer/06%20CLIP/">CLIP</a>
</li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">AIGC</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../07%20AIGC/01%20Theory/">理论</a>
</li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">细分方向</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../08%20Subdivision%20direction/Denoise/01%20Paper%20list/">Denoise</a>
</li>

        
            
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">SuperResolution</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../08%20Subdivision%20direction/SuperResolution/01%20SISR%20Paper%20list/">SISR Paper list</a>
</li>

        
            
<li >
    <a href="../../08%20Subdivision%20direction/SuperResolution/02%20VSR%20Paper%20list/">VSR Paper list</a>
</li>

        
    </ul>
  </li>

        
            
<li >
    <a href="../../08%20Subdivision%20direction/zero%20shot/01%20Paper%20list/">zero shot</a>
</li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">机器学习</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../09%20Mechine%20Learning/01%20Theory/">介绍</a>
</li>

        
    </ul>
  </li>

                    
                        
<li >
    <a href="../../legacy/">历史存档</a>
</li>

                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../../code_repo/">代码仓库</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> 搜索
                    </a>
                </li>
                <li >
                    <a rel="next" href="../05%20YOLOv1/">
                        <i class="fa fa-arrow-left"></i> 上一节
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../07%20YOLOv3/">
                        下一节 <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/learnAI-CN/learnAI-code">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
                <li>
                    <a href="/img/self.png">
                            <img class="paypal" src="/img/paypal_logo.png" alt="">
                        关于作者
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#yolov2">YOLOv2</a></li>
        
            <li><a href="#_1">改进列表</a></li>
        
            <li><a href="#batch-normalization">Batch Normalization</a></li>
        
            <li><a href="#high-resolution-classifier">High Resolution Classifier</a></li>
        
            <li><a href="#convolutional-with-anchor-boxes">Convolutional With Anchor Boxes</a></li>
        
            <li><a href="#dimension-clusters">Dimension Clusters</a></li>
        
            <li><a href="#direct-location-prediction">Direct location prediction</a></li>
        
            <li><a href="#fine-grained-features">Fine-Grained Features</a></li>
        
            <li><a href="#multi-scale-training">Multi-Scale Training</a></li>
        
            <li><a href="#faster">Faster</a></li>
        
            <li><a href="#_2">参考</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="yolov2">YOLOv2</h1>
<p>yolov2是YOLO算法的改进版本，相比于YOLO算法，YOLOv2在目标检测的精度和速度上都有所提高。</p>
<h2 id="_1">改进列表</h2>
<ul>
<li>Batch Normalization</li>
<li>High Resolution Classifier</li>
<li>Convolutional With Anchor Boxes</li>
<li>Dimension Clusters</li>
<li>Direct location prediction</li>
<li>Fine-Grained Features</li>
<li>Multi-Scale Training</li>
</ul>
<p>几种方法的效果对比如下图所示</p>
<p><img alt="" src="../../img/05/06/perform.jpg" /></p>
<h2 id="batch-normalization">Batch Normalization</h2>
<p>BN在15年提出后成功解决了训练难度大，网络每层分布变化的问题。因此yolov2在网络中引入了该技巧，并取得了mAP提升2%的收益。</p>
<h2 id="high-resolution-classifier">High Resolution Classifier</h2>
<p>之前我们提过yolov1采用了448<em>448的输入分辨率，当时是考虑到原始imageNet采用的224</em>224的输入，而更大尺寸的输入更有利于检测。
在yolov2中作者认为之前存在一个问题：直接用224<em>224训练好的预训练模型作为backbone效果还是不好。所以作者在检测前用448</em>448的图像finetune分类网络。所以目前的步骤是：
- 使用224 * 224的imageNet图像训练分类网络大概160个epoch，这个分类网络是作者自定义的DarkNet19，含有19个卷积层和5个池化层。
- 使用448 * 448的imageNet图像finetune分类网络，训练10个epoch，以此来适应高分辨率输入。
- 使用448 * 448的检测数据集（例如coco）进行微调整个网络。
通过该方式提升了4%mAP</p>
<h2 id="convolutional-with-anchor-boxes">Convolutional With Anchor Boxes</h2>
<p>yolov1中首先经过全连接层，然后预测框的坐标和宽高信息。前者会导致丢失空间信息，定位不准，后者网络回归的难度较大。为此
yolov2借鉴了Faster R-CNN的思想，引入anchor。其主要改进如下</p>
<p>1、删除网络中的全连接层和池化层，确保输出的卷积特征图有更高的分辨率
2、缩减网络输入为416<em>416。这一步的目的是为了让后面产生的卷积特征图宽高都为奇数，这样就可以产生一个center cell。
因为作者发现很多大目标都在图像中间，如果是偶数的话中心的四个坐标都要用来预测该物体，但奇数只需要使用一个就好了。
最终yolov2将416</em>416的输入得到13*13的特征图。</p>
<p>加入anchor boxes后，网络可以预测13<em>13</em>9=1521个boxes，但之前只有7<em>7</em>2=98个，所以召回率上升，准确率下降。</p>
<h2 id="dimension-clusters">Dimension Clusters</h2>
<p>Faster R-CNN的anchor是<strong>精选的先验框</strong>，尺度比例都预先定义好了，然后在训练中让网络学会调整boxes的宽高维度。
那有没有更好的预定义框呢？作者想通过K-means对训练集中的boxes进行了聚类，进而自动找到更好的boxes宽高维度。</p>
<p>但传统的K-means采用欧式距离衡量差异，box的尺寸越大误差越大，所以作者定义IOU为距离函数，使得误差和box的大小无关。</p>
<p>下图中左边为聚类结果，</p>
<p><img alt="" src="../../img/05/06/kmeans.png" /></p>
<p>横轴标志聚类中心数量，右边表示平均IOU，很自然的当聚类中心越多，IOU越高。综合考虑模型复杂度和召回率，作者最终选取5个聚类中心作为先验框。
右侧的图像显示了VOC和COCO相对质心的位置。两组先验框都更偏向于较细、较高的边界框，而COCO比VOC在大小方面有更大的变化。</p>
<p>通过该方式发现
（1）采用聚类分析得到的先验框比手动设置的先验框平均IOU值更高，因此模型更容易训练学习。
（2）仅选取5种box就能达到Faster RCNN的9种box的效果。</p>
<h2 id="direct-location-prediction">Direct location prediction</h2>
<p>每个检测模型中怎么回归框都是一个很重点的工作，在yolov2中，因为采用了Faster RCNN的anchor思想，因此开始也采用它回归框的计算。但后来发现该方法收敛不稳定，推断是预测anchor框中心位置（x，y）的问题。因此对其进行了改进。</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>bounding boxs：为网络预测的用于定位物体位置的框。
anchor: 为了便于网络预测，提前定义的一组框。网络会对这些预定义的anchor进行回归得到bounding box。</p>
</div>
<p>在Faster RCNN中，中心(x, y)的预测公式如下：</p>
<p>
<script type="math/tex; mode=display"> x = (t_x * w_a) + x_a </script>
<script type="math/tex; mode=display"> y = (t_y * h_a) + y_a </script>
</p>
<p>这个公式是无约束的，预测的边界框很容易向任何方向偏移。当<script type="math/tex"> t_x = 1</script>时，box向左偏移一个anchor的宽度；当<script type="math/tex"> t_x = -1</script>时，box向右偏移一个anchor的宽度，<script type="math/tex"> t_y </script>同理。
但这样导致的问题是，每个位置预测的框可以在图像的任何一个位置，导致模型不稳定。</p>
<p>所以在预测中心坐标的公式中，yolov2采用和yolov1相同的方法，即预测边界框中心点相对于对应cell左上角位置的相对偏移值。网络在最后一个卷积层输出13*13的特征图，每个位置通过anchor box先验预测5个bounding box，即上文聚类的结果，每个bounding box预测得到5个值。
分别是tx、ty、tw、th和to（类似YOLOv1的confidence）。</p>
<p>新的anchor box回归函数如下：</p>
<p>
<script type="math/tex; mode=display"> b_x = \sigma(t_x) + c_x </script>
<script type="math/tex; mode=display"> b_y = \sigma(t_y) + c_y </script>
<script type="math/tex; mode=display"> b_w = p_w*exp(t_w) </script>
<script type="math/tex; mode=display"> b_h = p_h*exp(t_h) </script>
<script type="math/tex; mode=display"> Pr(object) * IOU(b, object) = \theta(t_o) </script>
</p>
<p>其中<script type="math/tex"> b_x， b_y，b_w， b_h </script>为预测的bounding box相当于先验框anchor box的偏移。 <script type="math/tex"> \sigma </script>表示sigmoid函数，用于将<script type="math/tex"> t_x， t_y </script>约束在[0, 1]之间，<script type="math/tex"> c_x， c_y </script>表示每个cell相对于图像左上角的距离，
这样经过约束，得到的anchor box中心坐标可以约束在当前cell中，稳定训练。</p>
<p>综上，yolov2在预测框中心坐标的时候采用yolov1的方法，预测宽高回归时候采用Faster RCNN的公式。该方法能够更准确地确定目标的位置和大小，并且能够更高效地进行目标检测。</p>
<p><img alt="" src="../../img/05/06/anchor.png" /></p>
<h2 id="fine-grained-features">Fine-Grained Features</h2>
<p>这点和后来的多尺度预测很接近了。仅在最终的13<em>13的尺度图上进行预测，缺少很多细节信息，对检测小目标不友好。因此一个直观的想法是将26</em>26尺度的信息拼接到
最终的特征图上。</p>
<p>所以作者采用了转移层（ passthrough layer），先将26<em>26</em>512的特征图通过space2depth变为13 * 13 * 2048的特征图，然后与网络后面的13<em>13</em>1024特征图concat在一起形成13<em>13</em>3072的特征图，最后在该特征图上卷积做预测。</p>
<p>space2depth的操作如下图所示，将相邻四个像素在通道维进行重排，获得空间为1/4，而通道数变为以前的4倍的特征图。</p>
<p><img alt="" src="../../img/05/06/space.png" /></p>
<h2 id="multi-scale-training">Multi-Scale Training</h2>
<p>由于YOLOv2中只有卷积层和池化层，因此不需要固定的输入图片的大小。所以作者采用了多尺度训练提升网络鲁棒性。
即在使用检测数据集finetune整个网络的过程中，每迭代一定的次数，随机选择新的图片大小训练网络。</p>
<p>作者采用32的倍数作为输入的size，具体采用320、352、384、416、448、480、512、544、576、608共10种size。
不同的输入，最后产生的格点数不同，比如输入图片是320<em>320，那么输出格点是10</em>10，如果每个格点的先验框个数设置为5，那么总共输出500个预测结果；如果输入图片大小是608<em>608，输出格点就是19</em>19，共1805个预测结果。</p>
<p>这种机制使得网络可以更好地预测不同尺寸的图片，意味着同一个网络可以进行不同分辨率的检测任务</p>
<h2 id="faster">Faster</h2>
<p>作者采用Darknet-19作为新的分类网络结构，网络比较简洁，采用了较多的3*3卷积，参数量比VGG16小，但在ImageNet上，可以达到top-1 72.9%以及top-5 91.2%的精度。
网络结构组成如下图所示</p>
<p><img alt="" src="../../img/05/06/darknet19.png" /></p>
<h2 id="_2">参考</h2>
<p>https://arxiv.org/pdf/1612.08242.pdf
https://blog.csdn.net/lwplwf/article/details/82895409</p>

<div id="disqus_thread"></div>
<script>
    (function() {
        var d = document, s = d.createElement('script');

        s.src = '//learnopengl-cn.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>请启用JavaScript以浏览<a href="https://disqus.com/?ref_noscript" rel="nofollow">Disqus评论。</a></noscript></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Powered by <a href="http://www.mkdocs.org/">MkDocs</a> and <a href="http://bootswatch.com/yeti/">Yeti</a></center>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script src="../../js/base.js"></script>
        <script src="../../mathjax/MathJax.js?config=TeX-AMS_HTML"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">搜索</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            请在下面输入你要搜索的文本（仅支持英文）：
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="搜索..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>